import matplotlib.pyplot as plt
from fpdf import FPDF
from PIL import Image
import io
import json 

   st.subheader("Download Data")
#
# Generate a PDF report (raw data, cleaned image, scaled, includes comparison graph and data summary)
#
    mt.use("Agg") 

    pdf = FPDF()
    pdf.add_page()
    pdf.set_font("Times", "B", 16) 
    pdf.cell(0, 10, f"{option} Report", ln = True, align = 'C')

# Adding a table as text
    pdf.set_font("Times", "", 12)
    col = selected_data.columns[1]
    pdf.cell(0, 8, f"Time (s), {option}", ln = True)
    for i, row in selected_data.iterrows():
        pdf.cell(0, 5, f"{row['Time (s)']}, {row[col]}", ln = True)

# Add summary statistics 
    pdf.ln(5)
    pdf.set_font("Times", "B", 14)
    pdf.cell(0, 8, "Summary Statistics", ln = True)
    pdf.set_font("Times", "", 12)
    pdf.cell(0, 5, f"Mean: {selected_data[col].mean(): .2f}", ln = True)
    pdf.cell(0, 5, f"Max: {selected_data[col].max(): .2f}", ln = True)
    pdf.cell(0, 5, f"Min: {selected_data[col].min(): .2f}", ln = True)

# Save a plain graph to image and add to PDF
    fig_pdf, ax_pdf = plt.subplots()

    if option == 'Overview':
        for c in selected_data.columns[1:]:
            ax_pdf.plot(selected_data["Time (s)"], selected_data[c], label = c)
        ax_pdf.legend()
    else:
        ax_pdf.plot(selected_data["Time (s)"], selected_data[col], marker = 'o', markersize = 3)

    ax_pdf.set_xlabel("Time (s)", weight = 'bold', size = 15)
    ax_pdf.set_ylabel("Values" if option == "Overview" else col, weight = 'bold', size = 15)

# save chart as image
    fig_pdf.savefig("temp_plot.png", bbox_inches = 'tight')
    plt.close(fig_pdf)

# Scale the image to fit the page width 
    im = Image.open("temp_plot.png")
    img_width, img_height = im.size 
    max_width = 190
    scale = max_width / img_width 
    scaled_height = img_height * scale

# Add new page if image it too tall: 
    if scaled_height > 277: 
        pdf.add_page()
    pdf.image("temp_plot.png", x = 10, y = pdf.get_y() + 5, w = max_width, h = scaled_height)

# Includes comparison chart if it exists 
    try: 
        compare_variables
        if len(compare_variables) > 0:
            fig_comp, ax_comp = plt.subplots()
            for var in compare_variables:
                df = data_dict[var]
                y_col2 = df.columns[1]
                ax_comp.plot(df["Time (s)"], df[y_col2], label = var, marker = 'o', markersize = 3)
            ax_comp.set_xlabel("Time (s)", weight = 'bold', size = 15)
            ax_comp.set_ylabel("Values", weight = 'bold', size = 15)
            ax_comp.legend()

    # Save comparison graph 
        fig_comp.savefig("comparison_plot.png", bbox_inches = 'tight')
        plt.close(fig_comp)

    # Add comparison chart to a new page
        pdf.add_page()
        im_comp = Image.open("comparison_plot.png")
        img_width_comp, img_height_comp = im_comp.size
        scale = max_width / img_width_comp
        scaled_height_comp = img_height_comp * scale
        pdf.image("comparison_plot.png", x = 10, y = pdf.get_y(), w = max_width, h = scaled_height_comp)
    except NameError:
        pass            # if comparison mode was not used then skip

# Export PDF to BytesIO for Streamlit download
    pdf_output = io.BytesIO()
    pdf.output(pdf_output)
    pdf_output.seek(0)

    st.sidebar.download_button(
        label = "Download PDF Report",
        data = pdf_output,
        file_name = f"{option}_report.pdf",
        mime = "application/pdf"
    )

#
# Downloading CSV, Excel and JSON
#
# CSV
    csv_data = df_clean.to_csv(index = False).encode("utf-8")
    st.download_button(
        label = "Download Data in CSV Format",
        data=csv_data,
        file_name = f"{option}_cleaned.csv",
        mime="text/csv"
    )

# Excel
    excel_buffer = io.BytesIO()
    with pd.ExcelWriter(excel_buffer, engine="openpyxl") as writer:
        df_clean.to_excel(writer, index = False)
    excel_buffer.seek(0)

    st.download_button(
        label = "Download Data in Excel Format",
        data = excel_buffer,
        file_name = f"{option}_cleaned.xlsx",
        mime = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    )
 
# JSON
    json_data = df_clean.to_json(orient = "records")
    st.download_button(
        label = "Download Data in JSON Format",
        data = json_data,
        file_name = f"{option}_cleaned.json",
        mime = "application/json"
    )
